<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Outreach360 Whiteboard ‚Äî Auto-Realtime</title>
      <meta content="noindex, nofollow" name="robots"/>
<link rel="icon" type="image/png" sizes="32x32"
      href="https://github.com/Outreach360-Inc/games/raw/main/favicon.png">
<link rel="icon" type="image/png" sizes="16x16"
      href="https://github.com/Outreach360-Inc/games/raw/main/favicon.png">
<style>
  :root{ --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --note:#fef3c7; --noteBorder:#f59e0b; }
  html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .topbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);z-index:20}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .title{font-weight:700;font-size:18px}
  .badge{font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:8px;background:#f1f5f9;color:#0f172a}
  button{font-size:14px;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  button:hover{box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .toolbar{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tool-active{background:#111827;color:#fff}
  #boardWrap{max-width:1100px;margin:0 auto;padding:0 16px 24px;position:relative}
  #board{width:100%;height:70vh;border:1px solid var(--border);border-radius:16px;background:var(--bg);box-shadow:0 3px 12px rgba(0,0,0,.05)}
  #embedsLayer{position:absolute;left:16px;right:16px; top:0; height:70vh; pointer-events:none}
  .embedBox{position:absolute;width:320px;height:180px;background:#000;border:1px solid var(--border);border-radius:12px;overflow:hidden;pointer-events:auto}
  .embedBox .handle{position:absolute;right:6px;bottom:6px;width:16px;height:16px;background:#fff;border:1px solid var(--border);border-radius:4px;cursor:nwse-resize}
  .row{display:flex;align-items:center;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  input[type=color]{vertical-align:middle;height:28px;width:36px;border:1px solid var(--border);border-radius:6px;background:#fff}
  input[type=range]{vertical-align:middle}
  .footer{color:var(--muted);text-align:center;font-size:12px;padding:16px}
  .ok{color:#0a7}.err{color:#c00}.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="title">Outreach360 Whiteboard</div>
        <div id="boardTag" class="badge">Board: ‚Ä¶</div>
        <button id="copyLinkBtn">üîó Copy Share Link</button>
        <div id="status" class="muted">Connecting‚Ä¶</div>
      </div>
      <div class="row">
        <div id="proj" class="badge">Project: ‚Äî</div>
        <div id="doc" class="badge">Doc: ‚Äî</div>
        <div id="zoomLabel" class="badge">100%</div>
        <button id="zoomOut">-</button>
        <button id="zoomIn">+</button>
        <button id="zoomReset">Reset</button>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <button data-tool="select" class="toolBtn tool-active" title="Select/Move">üñ±Ô∏è Select</button>
    <button data-tool="pen" class="toolBtn" title="Pen">‚úèÔ∏è Pen</button>
    <button data-tool="highlighter" class="toolBtn" title="Highlighter">üñçÔ∏è Highlighter</button>
    <button id="rectBtn">‚ñ≠ Rect</button>
    <button id="circleBtn">‚óØ Circle</button>
    <button id="arrowBtn">‚û§ Arrow</button>
    <button id="textBtn">üî§ Text</button>
    <button id="stickyBtn">üóíÔ∏è Sticky</button>
    <button id="imgBtn">üñºÔ∏è Image</button>
    <button id="pdfBtn">üìÑ PDF (first page)</button>
    <button id="embedBtn" title="Embed YouTube or audio URL">üé¨ Embed</button>
    <button id="undoBtn">‚Ü∂ Undo</button>
    <button id="redoBtn">‚Ü∑ Redo</button>
    <button id="clearBtn">üßπ Clear</button>
    <div class="row" style="margin-left:auto;">
      <label>Color <input id="color" type="color" value="#111111"></label>
      <label>Highlighter <input id="hiColor" type="color" value="#ffee58"></label>
      <label>Width <input id="width" type="range" min="1" max="40" value="4"></label>
      <button id="pngBtn">‚¨áÔ∏è PNG</button>
      <button id="jsonBtn">‚¨áÔ∏è JSON</button>
      <button id="importBtn">‚¨ÜÔ∏è Import</button>
    </div>
  </div>

  <div id="boardWrap">
    <canvas id="board"></canvas>
    <div id="embedsLayer"></div>
  </div>

  <div class="footer">Share the exact link (includes <code>#b=‚Ä¶</code>). This build auto-connects to Firebase and starts realtime immediately.</div>

  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if (window['pdfjsLib']) { pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"; }</script>

  <script type="module">
    // --- Firebase ESM + Anonymous Auth (auto)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Embed your public web config (safe to expose)
    const firebaseConfig = {
      apiKey: "AIzaSyABlXMKOF4r3fpHc88HSZJpKi8xmbfA5Vc",
      authDomain: "whiteboard-dca62.firebaseapp.com",
      projectId: "whiteboard-dca62",
      storageBucket: "whiteboard-dca62.firebasestorage.app",
      messagingSenderId: "96159410011",
      appId: "1:96159410011:web:862f67e322c2b1a14bdc7e",
      measurementId: "G-234ZS5T0V2"
    };

    const $ = (s)=>document.querySelector(s);
    const statusEl = $("#status"), boardTag = $("#boardTag"), projEl = $("#proj"), docEl=$("#doc");

    // Room from URL (#b= or #room=). Default stable "main" so links always match.
    function getBoardId(){
      const p = new URLSearchParams(location.hash.replace(/^#/, ""));
      return p.get("b") || p.get("room") || "main";
    }
    function ensureHash(id){
      const url = new URL(location.href); url.hash = `b=${encodeURIComponent(id)}`; history.replaceState({}, "", url);
    }
    const boardId = getBoardId(); ensureHash(boardId); boardTag.textContent = "Board: "+boardId;

    // Canvas setup
    const canvas = new fabric.Canvas(document.getElementById("board"), { backgroundColor: "#f8fafc", preserveObjectStacking:true });
    const embedsLayer = document.getElementById("embedsLayer");
    const LKEY = "o360_board_"+boardId;

    function fitCanvas(){ const rect = document.getElementById("boardWrap").getBoundingClientRect(); canvas.setWidth(rect.width-32); canvas.setHeight(parseInt(getComputedStyle(embedsLayer).height)); canvas.renderAll(); }
    window.addEventListener("resize", fitCanvas); fitCanvas();

    // Minimal drawing tools
    let activeTool = "select"; let color = document.getElementById("color").value; let hiColor = document.getElementById("hiColor").value; let brushWidth = +document.getElementById("width").value; let zoom=1;
    document.querySelectorAll(".toolBtn").forEach(btn=>{ btn.onclick=()=>{ document.querySelectorAll(".toolBtn").forEach(b=>b.classList.remove("tool-active")); btn.classList.add("tool-active"); activeTool=btn.dataset.tool; canvas.isDrawingMode = (activeTool==="pen"||activeTool==="highlighter"); if (canvas.isDrawingMode){ const b=new fabric.PencilBrush(canvas); b.width=brushWidth; b.color= activeTool==="highlighter"? (hiColor+"77"): color; canvas.freeDrawingBrush=b; }}});
    document.getElementById("color").oninput=(e)=>{ color=e.target.value; if (canvas.isDrawingMode && activeTool==="pen") canvas.freeDrawingBrush.color=color; };
    document.getElementById("hiColor").oninput=(e)=>{ hiColor=e.target.value; if (canvas.isDrawingMode && activeTool==="highlighter") canvas.freeDrawingBrush.color=hiColor+"77"; };
    document.getElementById("width").oninput=(e)=>{ brushWidth=+e.target.value; if (canvas.isDrawingMode) canvas.freeDrawingBrush.width=brushWidth; };

    document.getElementById("rectBtn").onclick=()=>{ canvas.add(new fabric.Rect({ left:100, top:100, width:220, height:140, fill:"#e5e7eb", stroke:color, strokeWidth:2, rx:10, ry:10 })); };
    document.getElementById("circleBtn").onclick=()=>{ canvas.add(new fabric.Circle({ left:150, top:150, radius:60, fill:"#e5e7eb", stroke:color, strokeWidth:2 })); };
    document.getElementById("arrowBtn").onclick=()=>{ const line=new fabric.Line([200,200,320,240],{stroke:color,strokeWidth:3}); const tri=new fabric.Triangle({left:320,top:240,width:18,height:18,fill:color,angle:45,originX:"center",originY:"center"}); canvas.add(new fabric.Group([line,tri],{left:200,top:200})); };
    document.getElementById("textBtn").onclick=()=>{ canvas.add(new fabric.Textbox("Type here",{ left:120, top:120, fontSize:22, fill:color, editable:true, width:300 })); };
    document.getElementById("stickyBtn").onclick=()=>{ const rect=new fabric.Rect({ width:220, height:160, fill:"var(--note)", rx:12, ry:12, stroke:"var(--noteBorder)", strokeWidth:2, originX:"center", originY:"center" }); const t=new fabric.Textbox("Sticky note",{ width:180, fontSize:20, fill:"#111827", originX:"center", originY:"center" }); canvas.add(new fabric.Group([rect,t],{ left:200, top:200 })); };

    document.getElementById("pngBtn").onclick=()=>{ const data=canvas.toDataURL({format:"png",multiplier:2}); const a=document.createElement("a"); a.href=data; a.download=`o360-${boardId}.png`; a.click(); };
    document.getElementById("jsonBtn").onclick=()=>{ const blob=new Blob([JSON.stringify({ state:canvas.toDatalessJSON(), embeds:[] })],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`o360-${boardId}.json`; a.click(); URL.revokeObjectURL(url); };

    document.getElementById("undoBtn").onclick=()=>document.execCommand('undo');
    document.getElementById("redoBtn").onclick=()=>document.execCommand('redo');

    function setZoom(z){ zoom=Math.min(3,Math.max(0.3,z)); canvas.setZoom(zoom); document.getElementById("zoomLabel").textContent=Math.round(zoom*100)+"%"; }
    document.getElementById("zoomIn").onclick=()=>setZoom(zoom+0.1);
    document.getElementById("zoomOut").onclick=()=>setZoom(zoom-0.1);
    document.getElementById("zoomReset").onclick=()=>setZoom(1);

    document.getElementById("clearBtn").onclick=()=>{ if (!confirm("Clear everything from this board?")) return; canvas.clear(); canvas.setBackgroundColor("#f8fafc", canvas.renderAll.bind(canvas)); saveLocal(); pushToCloud(); };

    document.getElementById("copyLinkBtn").onclick=async()=>{ try{ await navigator.clipboard.writeText(location.href); statusEl.textContent="Link copied"; }catch{ statusEl.textContent="Copy failed"; } };

    function saveLocal(){ localStorage.setItem(LKEY, JSON.stringify({ state: canvas.toDatalessJSON() })); }
    const existing = localStorage.getItem(LKEY); if (existing){ try{ const obj=JSON.parse(existing); canvas.loadFromJSON(obj.state,()=>canvas.renderAll()); }catch{} }

    // --- Firebase init + anonymous sign-in + realtime (auto)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    try { await signInAnonymously(auth); } catch(e) { /* ignore if already signed-in */ }
    const db = getFirestore(app);

    projEl.textContent = `Project: ${app.options.projectId}`;
    const ref = doc(db, "boards", boardId);
    docEl.textContent = `Doc: boards/${boardId}`;

    // Apply remote updates
    let applying=false;
    onSnapshot(ref, (snap)=>{
      const d = snap.data();
      if (!d) return;
      if (applying) return;
      applying = true;
      canvas.loadFromJSON(d.data || d.state || {}, ()=>{ canvas.renderAll(); applying=false; saveLocal(); statusEl.innerHTML='<span class="ok">Live</span>'; });
    }, (err)=>{ statusEl.innerHTML = `<span class="err">${err.message}</span>`; });

    // Push local changes (debounced)
    let t; canvas.on("object:added", changed); canvas.on("object:modified", changed); canvas.on("object:removed", changed);
    function changed(){ if (applying) return; clearTimeout(t); t=setTimeout(pushToCloud, 220); }
    async function pushToCloud(){ try{ await setDoc(ref, { data: canvas.toDatalessJSON(), updatedAt: Date.now() }, { merge:true }); statusEl.textContent = "Synced"; } catch(e){ statusEl.innerHTML = `<span class=err>${e.message}</span>`; } }

  </script>
</body>
</html>
