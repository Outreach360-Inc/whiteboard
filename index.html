<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Whiteboard Sync — Diagnostics</title>
<style>
  :root { --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  .grid { display: grid; gap: 12px; max-width: 920px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px 16px; }
  .row { display: grid; grid-template-columns: 180px 1fr; gap: 10px; align-items: center; }
  code, .mono { font-family: var(--mono); font-size: 13px; }
  textarea { width: 100%; height: 40vh; font: 14px/1.5 var(--mono); }
  .ok { color: #0a7; }
  .warn { color: #b50; }
  .err { color: #c00; white-space: pre-wrap; }
  button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background: #fafafa; }
  .small { font-size: 12px; opacity: .8; }
</style>

<h1>Whiteboard Sync — Diagnostics</h1>

<div class="grid">
  <div class="card">
    <div class="row"><div>Current URL</div><div class="mono" id="u"></div></div>
    <div class="row"><div>Room ID</div><div class="mono" id="roomOut"></div></div>
    <div class="row"><div>Firestore Doc</div><div class="mono" id="docPath"></div></div>
    <div class="row"><div>Firebase Project</div><div class="mono" id="projectOut"></div></div>
    <div class="row"><div>Status</div><div id="status">Starting…</div></div>
    <div class="row"><div>Last Update</div><div class="mono" id="stamp">—</div></div>
    <div class="row"><div>Last Writer</div><div class="mono" id="writer">—</div></div>
  </div>

  <div class="card">
    <div class="row">
      <div>Set Room</div>
      <div>
        <input id="room" placeholder="demo" />
        <button id="setRoom">Use Room</button>
        <span class="small">Share the exact link AFTER this sets <code>#room=...</code></span>
      </div>
    </div>
    <div class="row">
      <div>Quick Test</div>
      <div>
        <button id="forceWrite">Force Write Test</button>
        <span class="small">Writes a random token so the other tab should change immediately</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div><strong>Shared Text</strong> (type here; the other browser should mirror live)</div>
    <textarea id="pad" placeholder="Type here…"></textarea>
  </div>

  <div class="card small">
    <div><strong>Troubleshooting Hints</strong></div>
    <ul>
      <li>If you see <span class="err">permission-denied</span>, your Firestore Rules are blocking. For testing, use:
        <pre class="mono">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} { allow read, write: if true; }
  }
}</pre>
        (Set in Firebase Console → Firestore Database → Rules)
      </li>
      <li>If the “Firebase Project” value differs between the two browsers, you’re using different configs (env vars or old cache). Hard-refresh or redeploy.</li>
      <li>If the “Firestore Doc” path differs, your room IDs/URL hashes differ.</li>
      <li>If one tab updates and the other doesn’t, check for a stale service worker (hard reload) or that both are on the same Netlify deploy (Prod vs Preview).</li>
    </ul>
  </div>
</div>

<script type="module">
  // --- 1) Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- 2) YOUR Firebase config (keep yours here)
  const firebaseConfig = {
    apiKey: "AIzaSyABlXMKOF4r3fpHc88HSZJpKi8xmbfA5Vc",
    authDomain: "whiteboard-dca62.firebaseapp.com",
    projectId: "whiteboard-dca62",
    storageBucket: "whiteboard-dca62.firebasestorage.app",
    messagingSenderId: "96159410011",
    appId: "1:96159410011:web:862f67e322c2b1a14bdc7e",
    measurementId: "G-234ZS5T0V2"
  };

  // --- 3) Initialize
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- 4) Helpers / DOM
  const el = (id) => document.getElementById(id);
  const pad = el("pad");
  const status = el("status");
  const stamp = el("stamp");
  const writer = el("writer");
  const u = el("u");
  const projectOut = el("projectOut");
  const roomOut = el("roomOut");
  const docPathOut = el("docPath");
  const roomInput = el("room");

  // Show the full URL to confirm both browsers match exactly
  u.textContent = location.href;

  // Room from URL hash (#room=xyz)
  function readRoomFromHash() {
    const params = new URLSearchParams(location.hash.replace(/^#/, ""));
    return params.get("room") || "demo";
  }
  function setRoomInHash(r) {
    const url = new URL(location.href);
    url.hash = `room=${encodeURIComponent(r)}`;
    history.replaceState({}, "", url);
  }

  // Unique client id so you can see who wrote last
  const clientId = Math.random().toString(36).slice(2);

  // --- 5) Attach listeners
  let unsub = null;
  let writing = false;

  function attach(roomId) {
    if (unsub) { unsub(); unsub = null; }

    const ref = doc(db, "boards", roomId);
    roomOut.textContent = roomId;
    docPathOut.textContent = `boards/${roomId}`;
    projectOut.textContent = app.options?.projectId || "(unknown)";

    // Live listener
    unsub = onSnapshot(ref, (snap) => {
      const data = snap.data();
      if (data) {
        if (!writing) pad.value = data.text || "";
        stamp.textContent = data.updatedAt ? new Date(data.updatedAt).toISOString() : "—";
        writer.textContent = data.updatedBy || "—";
        status.innerHTML = `<span class="ok">Listening to Firestore. Connected.</span>`;
      } else {
        status.innerHTML = `<span class="warn">No document yet. Start typing to create it.</span>`;
      }
    }, (e) => {
      status.innerHTML = `<span class="err">Listener error: ${e.message}</span>`;
      console.error(e);
    });

    // Debounced writer
    let t;
    pad.oninput = () => {
      clearTimeout(t);
      t = setTimeout(async () => {
        try {
          writing = true;
          await setDoc(ref, { text: pad.value, updatedAt: Date.now(), updatedBy: clientId }, { merge: true });
        } catch (e) {
          status.innerHTML = `<span class="err">Write error: ${e.message}</span>`;
          console.error(e);
        } finally {
          writing = false;
        }
      }, 120);
    };

    // Force write test button
    el("forceWrite").onclick = async () => {
      const token = Math.random().toString(36).slice(2);
      try {
        await setDoc(ref, { text: `[token:${token}]\n` + (pad.value || ""), updatedAt: Date.now(), updatedBy: clientId }, { merge: true });
      } catch (e) {
        status.innerHTML = `<span class="err">Write error: ${e.message}</span>`;
      }
    };
  }

  // Set room button
  el("setRoom").onclick = () => {
    const r = (roomInput.value || "demo").trim();
    setRoomInHash(r);
    attach(r);
    u.textContent = location.href; // update display
  };

  // Initial attach
  const initialRoom = readRoomFromHash();
  roomInput.value = initialRoom;
  attach(initialRoom);
</script>
